<!DOCTYPE html>
<html lang="fr">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Smart WheelChair Application">
    <meta name="author" content="CERAH">

    <title>SWApp - Mesure</title>

    <!-- Custom fonts for this template-->
    <link rel="stylesheet" type="text/css" href="vendor/fontawesome-free/css/all.min.css">
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i">

    <!-- Custom styles for this template-->
    <link rel="stylesheet" href="css/sb-admin-2.min.css">


    <!-- Page level styles -->
    <link rel="stylesheet" href="css/mesure.css">
    <!-- Jasny-Bootstrap -->
    <link rel="stylesheet" href="vendor/jasny/css/jasny-bootstrap.min.css">
    <!-- Holder.js -->
    <script src="vendor/holderjs/holder.min.js"></script>

</head>

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Sidebar -->
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

            <!-- Sidebar - Brand -->
            <a class="sidebar-brand d-flex align-items-center justify-content-center my-2" href="index.html">
                <div class="sidebar-brand-icon rotate-n-15">
                    <i class="fas fa-laugh-wink"></i>
                </div>
                <div class="sidebar-brand-text mx-3">SWApp <sup>2</sup></div>
            </a>

            <!-- Divider -->
            <hr class="sidebar-divider my-1">

            <!-- Nav Item - Dashboard -->
            <li class="nav-item">
                <a class="nav-link" href="index.html">
                    <i class="fas fa-fw fa-wheelchair"></i>
                    <span>Réglage du Fauteuil</span></a>
            </li>

            <!-- Nav Item - Mesure -->
            <li class="nav-item active">
                <a class="nav-link" href="mesure.html">
                    <i class="fas fa-fw fa-chart-area fa-ruler-combined"></i>
                    <span>Mesure Photo</span></a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Heading -->
            <div class="sidebar-heading">
                Configuration
            </div>

            <!-- Nav Item - Pages Collapse Menu -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseTwo"
                   aria-expanded="true" aria-controls="collapseTwo">
                    <i class="fas fa-fw fa-cog"></i>
                    <span>Applications</span>
                </a>
                <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Custom Components:</h6>
                        <a class="collapse-item" href="buttons.html">Buttons</a>
                        <a class="collapse-item" href="cards.html">Cards</a>
                    </div>
                </div>
            </li>

            <!-- Nav Item - Utilities Collapse Menu -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseUtilities"
                   aria-expanded="true" aria-controls="collapseUtilities">
                    <i class="fas fa-fw fa-wrench"></i>
                    <span>Utilities</span>
                </a>
                <div id="collapseUtilities" class="collapse" aria-labelledby="headingUtilities"
                     data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Custom Utilities:</h6>
                        <a class="collapse-item" href="utilities-color.html">Colors</a>
                        <a class="collapse-item" href="utilities-border.html">Borders</a>
                        <a class="collapse-item" href="utilities-animation.html">Animations</a>
                        <a class="collapse-item" href="utilities-other.html">Other</a>
                    </div>
                </div>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Heading -->
            <div class="sidebar-heading">
                Documents
            </div>

            <!-- Nav Item - Pages Collapse Menu -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapsePages"
                   aria-expanded="true" aria-controls="collapsePages">
                    <i class="fas fa-fw fa-database"></i>
                    <span>Données enregistrés</span>
                </a>
                <div id="collapsePages" class="collapse" aria-labelledby="headingPages" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Login Screens:</h6>
                        <a class="collapse-item" href="login.html">Login</a>
                        <a class="collapse-item" href="register.html">Register</a>
                        <a class="collapse-item" href="forgot-password.html">Forgot Password</a>
                        <div class="collapse-divider"></div>
                        <h6 class="collapse-header">Other Pages:</h6>
                        <a class="collapse-item" href="404.html">404 Page</a>
                        <a class="collapse-item" href="blank.html">Blank Page</a>
                    </div>
                </div>
            </li>

            <!-- Nav Item - Tables -->
            <li class="nav-item">
                <a class="nav-link" href="tables.html">
                    <i class="fas fa-fw fa-book-open"></i>
                    <span>Mode d'emploie</span></a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider d-none d-md-block">

            <!-- Nav Item - Help -->
            <li class="nav-item">
                <a class="nav-link" href="tables.html">
                    <i class="fas fa-fw fa-phone-alt"></i>
                    <span>Aide & Contact</span></a>
            </li>

            <!-- Sidebar Toggler (Sidebar) -->
            <div class="text-center d-none d-md-inline">
                <button class="rounded-circle border-0 my-4" id="sidebarToggle"></button>
            </div>

        </ul>
        <!-- End of Sidebar -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- Main Content -->
            <div id="content">

                <!-- Topbar -->
                <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">

                    <!-- Title -->
                    <div class="container-fluid d-sm-flex align-items-center justify-content-between mx-3">
                        <h1 class="h3 mb-0 text-gray-800">Mesure Photo</h1>
                    </div>

                    <!-- Sidebar Toggle (Topbar) -->
                    <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                        <i class="fa fa-bars"></i>
                    </button>

                </nav>
                <!-- End of Topbar -->

                <!-- Begin Page Content -->
                <div class="container-fluid">

                    <!-- Page Heading -->
                    <!--<h1 class="h3 mb-2 text-gray-800">Mesure Photo</h1>-->
                    <p class="mb-4">Mesurer les paramètres du fauteuil par deux photos, pour plus de détail, veuillez consulter notre <a
                            target="_blank" href="https://www.chartjs.org/docs/latest/">Mode d'emploi</a>.</p>



                    <!-- Navigation Tabs -->
                    <ul class="nav nav-pills mb-3" id="navTab_mesure" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" id="home-tab" data-toggle="pill" data-target="#home" type="button" role="home" aria-controls="home" aria-selected="true">
                                Home
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="fauteuil_face-tab" data-toggle="pill" data-target="#fauteuil-face" type="button" role="tab" aria-controls="fauteuil_face" aria-selected="false">
                                Fauteuil-Face
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="fauteuil_profil-tab" data-toggle="pill" data-target="#fauteuil_profil" type="button" role="tab" aria-controls="falteuil_profil" aria-selected="false">
                                Fauteuil-Profil
                            </a>
                        </li>
                    </ul>
                    <div class="tab-content" id="myTabContent">
                        <!-- Tab Photos -->
                        <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                            <div class="row">
                                <div class="col-lg-7">
                                    <div class="card shadow mb-4">
                                        <!-- Card head -->
                                        <div class="card-header py-3">
                                            <h6 class="m-0 font-weight-bold text-primary">Téléchargement</h6>
                                        </div>
                                        <!-- Card body -->
                                        <div class="card-body">
                                            <div class="fileinput fileinput-new" data-provides="fileinput">
                                                <div class="fileinput-new img-thumbnail" style="width: 300px; height: 200px;">
                                                    <img data-src="holder.js/100px100p?text=Face"  alt="...">
                                                </div>
                                                <div class="fileinput-preview fileinput-exists img-thumbnail"
                                                     id="image_fauteuil_face" style="width: 40%; height: 100%;"></div>
                                                <div>
                                                <span class="btn btn-outline-secondary btn-file">
                                                    <span class="fileinput-new">Select image</span>
                                                    <span class="fileinput-exists">Change</span>
                                                    <input type="file" accept="image/*" id="file_fauteuil_face" name="...">
                                                </span>
                                                    <a href="#" class="btn btn-outline-secondary fileinput-exists" data-dismiss="fileinput">Remove</a>
                                                </div>
                                            </div>

                                            <div class="fileinput fileinput-new" data-provides="fileinput">
                                                <div class="fileinput-new img-thumbnail" style="width: 300px; height: 200px;">
                                                    <img data-src="holder.js/100px100p?text=Profil"  alt="...">
                                                </div>
                                                <div class="fileinput-preview fileinput-exists img-thumbnail"
                                                     id="image_fauteuil_profil" style="width: 40%; height: 100%;"></div>
                                                <div>
                                                <span class="btn btn-outline-secondary btn-file">
                                                    <span class="fileinput-new">Select image</span>
                                                    <span class="fileinput-exists">Change</span>
                                                    <input type="file" accept="image/*" id="file_fauteuil_profil" name="...">
                                                </span>
                                                    <a href="#" class="btn btn-outline-secondary fileinput-exists" data-dismiss="fileinput">Remove</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Conseils -->
                                <div class="col-lg-5">
                                    <div class="card shadow mb-4">
                                        <div class="card-header py-3">
                                            <h6 class="m-0 font-weight-bold text-primary">Conseils</h6>
                                        </div>
                                        <div class="card-body">
                                            <p>Prenez les photos à 4 mètres</p>
                                            <p>MODE D'EMPLOI</p>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <div class="tab-pane fade" id="fauteuil-face" role="tabpanel" aria-labelledby="fauteuil_face-tab">
                            <div class="row">
                                <div class="col-xl-7 col-lg-6">
                                    <!--Konva-->
                                    <div class="card shadow mb-4" id="card_fauteuil_face">
                                        <div class="card-header py-3">
                                            <div class="row">
                                                <h6 class="m-0 font-weight-bold text-primary col-4">Photo</h6>
                                                <div class="slidecontainer col-4" align="right">
                                                    <span align="right">Luminosité</span>
                                                    <input id="input_brightness_fauteuil_face"
                                                           value="0" step="0.05" min="-0.8" max="0.8"
                                                           class="form-range" type="range"
                                                           style="width: 80%" />
                                                </div>
                                                <div class="slidecontainer col-4" align="right">
                                                    <span align="right">Point Size</span>
                                                    <input id="input_pointSize_fauteuil_face"
                                                           value="5" step="0.5" min="3" max="7"
                                                           class="form-range" type="range"
                                                           style="width: 80%" />
                                                </div>
                                            </div>

                                        </div>
                                        <div class="card-body" id="konva_fauteuil_face">

                                        </div>
                                    </div>
                                </div>

                                <!-- List -->
                                <div class="col-xl-5 col-lg-6">
                                    <div class="card shadow mb-4">
                                        <!-- Card Header - Dropdown -->
                                        <div class="card-header py-3">
                                            <h6 class="m-0 font-weight-bold text-primary">Liste des points</h6>
                                        </div>
                                        <!-- Card Body -->
                                        <div class="card-body">
                                            <table class="table table-striped table-bordered table-hover" id="table_fauteuil_face">
                                                <thead>
                                                <tr><th>Point</th><th>Coordonnées</th></tr>
                                                </thead>
                                                <tbody data-link="row" class="rowlink">
                                                <tr id="tff_c1b"><td>Calibration1_Bas</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tff_c1h"><td>Calibration1_Haut</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tff_c2b"><td>Calibration2_Bas</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tff_c2h"><td>Calibration2_Haut</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tff_ravtc"><td>Roue Avant_Centre</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tff_ravte"><td>Roue Avant_Extrémité</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tff_fh"><td>Fourche_Haut Milieu</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tff_pp"><td>Potence_Palette</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tff_savt"><td>Siège_Avant</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tff_rarre"><td>Roue Arrière_Extrémité</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tff_mce"><td>Main Courant_Extrémité</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tff_rarrc"><td>Roue Arrière_Centre</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tff_sarr"><td>Siège_Arrière</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tff_dh"><td>Dossier_Haut</a></td><td class="rowlink-skip"></td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>


                        <div class="tab-pane fade" id="fauteuil_profil" role="tabpanel" aria-labelledby="fauteuil_profil-tab">
                            <div class="row">
                                <div class="col-xl-7 col-lg-6">
                                    <!--Konva-->
                                    <div class="card shadow mb-4" id="card_fauteuil_profil">
                                        <div class="card-header py-3">
                                            <div class="row">
                                                <h6 class="m-0 font-weight-bold text-primary col-4">Photo</h6>
                                                <div class="slidecontainer col-4" align="right">
                                                    <span align="right">Luminosité</span>
                                                    <input id="input_brightness_fauteuil_profil"
                                                           value="0" step="0.05" min="-0.8" max="0.8"
                                                           class="form-range" type="range"
                                                           style="width: 80%" />
                                                </div>
                                                <div class="slidecontainer col-4" align="right">
                                                    <span align="right">Point Size</span>
                                                    <input id="input_pointSize_fauteuil_profil"
                                                           value="5" step="0.5" min="3" max="7"
                                                           class="form-range" type="range"
                                                           style="width: 80%" />
                                                </div>
                                            </div>

                                        </div>
                                        <div class="card-body" id="konva_fauteuil_profil">

                                        </div>
                                    </div>
                                </div>

                                <!-- List -->
                                <div class="col-xl-5 col-lg-6">
                                    <div class="card shadow mb-4">
                                        <!-- Card Header - Dropdown -->
                                        <div class="card-header py-3">
                                            <h6 class="m-0 font-weight-bold text-primary">Liste des points</h6>
                                        </div>
                                        <!-- Card Body -->
                                        <div class="card-body">
                                            <table class="table table-striped table-bordered table-hover" id="table_fauteuil_profil">
                                                <thead>
                                                <tr><th>Point</th><th>Coordonnées</th></tr>
                                                </thead>
                                                <tbody data-link="row" class="rowlink">
                                                <tr id="tfp_c1b"><td>Calibration1_Bas</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tfp_c1h"><td>Calibration1_Haut</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tfp_c2b"><td>Calibration2_Bas</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tfp_c2h"><td>Calibration2_Haut</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tfp_ravtc"><td>Roue Avant_Centre</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tfp_ravte"><td>Roue Avant_Extrémité</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tfp_fh"><td>Fourche_Haut Milieu</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tfp_pp"><td>Potence_Palette</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tfp_savt"><td>Siège_Avant</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tfp_rarre"><td>Roue Arrière_Extrémité</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tfp_mce"><td>Main Courant_Extrémité</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tfp_rarrc"><td>Roue Arrière_Centre</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tfp_sarr"><td>Siège_Arrière</a></td><td class="rowlink-skip"></td></tr>
                                                <tr id="tfp_dh"><td>Dossier_Haut</a></td><td class="rowlink-skip"></td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
                <!-- /.container-fluid -->

            </div>
            <!-- End of Main Content -->

            <!-- Footer -->
            <footer class="sticky-footer bg-white">
                <div class="container my-auto">
                    <div class="copyright text-center my-auto">
                        <span>Copyright &copy; Invalides CERAH</span>
                    </div>
                </div>
            </footer>
            <!-- End of Footer -->

        </div>
        <!-- End of Content Wrapper -->

    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>

    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin-2.min.js"></script>

    <!-- Page level plugins -->
    <script src="vendor/jasny/js/jasny-bootstrap.min.js"></script>
    <script src="https://unpkg.com/konva@8/konva.min.js"></script>


</body>

<script>
    // ----- Configs ------
    // Circle default parameter
    pointRadius=5;
    // Scale step
    var scaleBy = 1.05;

    // ----- Functionality variables -----
    // This variable should contain id of navTab for photos
    names = ["fauteuil_face", "fauteuil_profil"];


    // ----- Do not change ------
    // Data of all points
    pointData={};
    // Status of selected point in list table
    pointIndex = {};
    // Status of mouse click on image (Used in mouseup event listener of all circles)
    moved=0;


    // List of point should be refreshed after every change
    // Apply color to 'unsaved', 'active', 'saved' rows
    // Update point coordinate data
    function refreshTable(targetTable) {
        // Reinitialize the list table
        Array.from(targetTable.rows).forEach(e=>e.setAttribute('class',''));
        // 'Saved' point
        for (let i in pointData) {
            document.getElementById(i).setAttribute('class','table-success'); // Style included in Bootstrap template
            // Show saved data
            document.getElementById(i).children[1].innerHTML='x:'+parseInt(pointData[i].x)+'&emsp;y:'+parseInt(pointData[i].y);
            // Show saved status
            // document.getElementById(i).children[2].innerHTML='Enregistré';
        }

        let targetName = targetTable.id.replace(/table_/,"")
        // 'Active' point
        if (pointIndex[targetName]>0 && pointIndex[targetName] < targetTable.rows.length){
            targetTable.rows[pointIndex[targetName]].setAttribute('class','table-info');
        }
    }



    // todo: source and target
    function resizeKonva(targetName) {
        var getStyle = function(dom, attr){
            return dom.currentStyle ? dom.currentStyle[attr] : getComputedStyle(dom, false)[attr];
        }
        let div = document.getElementById('konva_'+targetName);
        var clientWidth = div.clientWidth;
        var paddingLeft = Number(getStyle(div,"paddingLeft").replace(/\s+|px/gi,""));
        var paddingRight = Number(getStyle(div,"paddingRight").replace(/\s+|px/gi,""));
        var width = clientWidth - paddingLeft - paddingRight;
        var height = width * 3 / 4;

        stage[targetName].width(width);
        stage[targetName].height(height);

        let naturalWidth = image[targetName].naturalWidth;
        let naturalHeight = image[targetName].naturalHeight;

        if (naturalWidth > naturalHeight){
            groupImage[targetName].scale({x: stage[targetName].width()/naturalWidth, y: stage[targetName].width()/naturalWidth});
            stage[targetName].height(stage[targetName].width() / naturalWidth * naturalHeight);
        }else{
            stage[targetName].height(stage[targetName].width() / naturalWidth * naturalHeight);
            groupImage[targetName].scale({x: stage[targetName].height()/naturalHeight, y: stage[targetName].height()/naturalHeight});
        }
        scaleMin = 0.9 * stage[targetName].width()/naturalWidth;

        // Keep circle size
        // Changing image will resize and rescale the Konva stage (as above)
        groupPoint[targetName].children.forEach((child)=>{
            child.scale({x: 1/(stage[targetName].width()/naturalWidth), y: 1/(stage[targetName].width()/naturalWidth)})
        })
    }


    //
    var stage = {};
    var layer = {};
    var image = {};
    var KonvaImage = {};
    var groupImage = {};
    var groupPoint = {};

    var text = {};
    var text2 = {};
    var text3 = {};

    var tooltipLayer = {};
    var tooltip = {};
    var tag = {};


    for (index in names) {

        let targetName = names[index]

        pointIndex[targetName] = 0;

        // Event listener for point list table
        document.getElementById('table_'+targetName).addEventListener('mouseup',function(e){
            pointIndex[targetName]=e.path[1].rowIndex; // path[1] only work for 'mouseup' event, path[2] for 'mousedown'
            refreshTable(this)
        })

        stage[targetName] = new Konva.Stage({
            container: "konva_"+targetName,
        })

        layer[targetName] = new Konva.Layer();
        stage[targetName].add(layer[targetName]);

        image[targetName] = new Image();
        image[targetName].src='/test/face.jpg';
        KonvaImage[targetName] = new Konva.Image({
            image: image[targetName],
            draggable: false,
            id: "konvaImage_"+targetName,
        });

        // Cache image in Konva when loading finished
        image[targetName].onload = function() {
            KonvaImage[targetName].width(this.naturalWidth);
            KonvaImage[targetName].height(this.naturalHeight);
            KonvaImage[targetName].cache();
            KonvaImage[targetName].filters([Konva.Filters.Brighten]);
        }

        groupImage[targetName] = new Konva.Group({
            draggable: true,
        })
        groupImage[targetName].add(KonvaImage[targetName]);

        groupPoint[targetName] = new Konva.Group();
        groupImage[targetName].add(groupPoint[targetName]);

        layer[targetName].add(groupImage[targetName])

        document.getElementById('file_'+targetName).addEventListener("input", function(e){
            image[targetName].src = URL.createObjectURL(e.target.files[0]);
            groupImage[targetName].position({x:0, y:0});
        })

        const aspectRatio = stage[targetName].width() / stage[targetName].height();
        const imageRatio = KonvaImage[targetName].width() / KonvaImage[targetName].height();
        if (aspectRatio <= imageRatio) {
            newWidth = stage[targetName].width();
            newHeight = stage[targetName].width() / imageRatio;
        } else {
            newWidth = stage[targetName].height() * imageRatio;
            newHeight = stage[targetName].height();
        }
        KonvaImage[targetName].size({
            width: newWidth,
            height: newHeight
        })

        document.getElementById('input_brightness_'+targetName).addEventListener('input', function(){
            KonvaImage[targetName].brightness(parseFloat(this.value));
        })

        document.getElementById('input_pointSize_'+targetName).addEventListener('input', function(){
            groupPoint[targetName].children.forEach((e)=>{
                e.radius(this.value);
            })
        })

        resizeKonva(targetName);

        text[targetName] = new Konva.Text({
            text: 'Click on the canvas to draw a circle',
            fontSize: 20,
            draggable: false,
            y:45,
        });
        layer[targetName].add(text[targetName]);

        text2[targetName] = new Konva.Text({
            text: 'Pointer Position',
            fontSize: 20,
            y:0,
        })
        layer[targetName].add(text2[targetName]);

        text3[targetName] = new Konva.Text({
            text: 'groupImage Position',
            fontSize: 20,
            y:20,
        })
        layer[targetName].add(text3[targetName]);

        stage[targetName].on('mouseover mousemove dragmove', ()=>{
            mousePos = stage[targetName].getRelativePointerPosition();
            text2[targetName].text('Pointer Position:'+mousePos.x+','+mousePos.y)
            text3[targetName].text('groupImage Position:'+groupImage[targetName].x()+','+groupImage[targetName].y())
        })

        stage[targetName].on('mouseout', ()=>{
            text2[targetName].text('Pointer Position:-1,-1')
        })

        stage[targetName].on('mouseover mousemove dragmove', function (evt) {
            moved = 1;
        });

        KonvaImage[targetName].on('mouseup', function(e){
            // Only active on left click and no dragging movement
            if (e.evt.button==0 && moved==0){
                // Get event List Table
                // todo: variable target table
                let table = document.getElementById('table_'+targetName)

                if (pointIndex[targetName] == 0) {
                    window.alert("Choisir d'abord un point parmi la liste")
                }else if (pointIndex[targetName] < table.rows.length) {
                    // Get cursor position
                    var pos = KonvaImage[targetName].getRelativePointerPosition();
                    // Get target point's ID
                    let pointID = table.rows[pointIndex[targetName]].id;

                    // Check if circle exist
                    let existingCircle = stage[targetName].find('#'+pointID)[0];

                    if (existingCircle) {
                        // Moving existing circle to new position
                        tween = new Konva.Tween({
                            node: existingCircle,
                            duration: 0.3,
                            x: pos.x,
                            y: pos.y,
                            easing: Konva.Easings.EaseInOut,
                        }).play();
                    }else{
                        // Creat circle
                        var circle = new Konva.Circle({
                            x: pos.x,
                            y: pos.y,
                            fill: 'red',
                            stroke: 'blue',
                            strokeWidth: 0,
                            radius: pointRadius,
                            opacity: 0.5,
                            draggable: true,
                            scale: {x:1/groupImage[targetName].scaleX(),y:1/groupImage[targetName].scaleY()},
                            id: pointID,
                        });
                        // Add circle
                        groupPoint[targetName].add(circle);
                        // Add drag listener to circle
                        circle.on('dragmove', (e) => {
                            const absPos = circle.getAbsolutePosition();
                            const relPos = groupImage[targetName].getRelativePointerPosition();
                            const image = groupImage[targetName].children[0];

                            // Limit point in image border
                            let newAbsPos = { ...absPos };
                            let newRelPos = { ...relPos };
                            if (relPos.x < 0) {
                                newAbsPos.x = groupImage[targetName].x();
                                newRelPos.x = 0;
                            }
                            if (relPos.y < 0) {
                                newAbsPos.y = groupImage[targetName].y();
                                newRelPos.y = 0;
                            }
                            if (relPos.x > image.width()) {
                                newAbsPos.x = image.width()*groupImage[targetName].scaleX() + groupImage[targetName].x();
                                newRelPos.x = image.width();
                            }
                            if (relPos.y > image.height()) {
                                newAbsPos.y = image.height()*groupImage[targetName].scaleY() + groupImage[targetName].y();
                                newRelPos.y = image.height();
                            }
                            circle.setAbsolutePosition(newAbsPos);

                            // Save new position to Data
                            pointData[circle.id()] = newRelPos;

                            // Test function : Show coordinate on image frame
                            text[targetName].text('absPos:\t'+newAbsPos.x+','+newAbsPos.y+'\nrelPos:\t'+relPos.x+','+relPos.y)

                            refreshTable(table)

                        });

                        // Show a stroke on hover
                        circle.on('mouseover mousemove dragmove', () => {
                            // Show border
                            circle.strokeWidth(2);

                            // Update tooltip
                            const absPos = circle.getAbsolutePosition();
                            // var mousePos = node.getStage().getPointerPosition();

                            tooltip[targetName]
                                .getText()
                                .text(document.getElementById(circle.id()).children[0].innerHTML);

                            // Tried to prevent tooltip from getting out of frame
                            // Limited by Konva, tag position related to pointerDirection only on creation of element

                            // if (absPos.y < tooltip.height()) {
                            //     tag.pointerDirection('up')
                            //     tooltip.position({
                            //         x: absPos.x,
                            //         y: absPos.y + tooltip.height() + tag.pointerHeight() + pointRadius,
                            //     });
                            // }else{
                            //     tag.pointerDirection('down')
                            //     tooltip.position({
                            //         x: absPos.x,
                            //         y: absPos.y - pointRadius,
                            //     });
                            // }
                            //
                            // if (absPos.x < tooltip.width()/2) {
                            //     tag.pointerDirection('left')
                            //     tooltip.position({
                            //         x: absPos.x + pointRadius,
                            //         y: absPos.y,
                            //     });
                            // }else if (absPos.x > stage.width() - tooltip.width()/2) {
                            //     tag.pointerDirection('right')
                            //     tooltip.position({
                            //         x: absPos.x - pointRadius,
                            //         y: absPos.y,
                            //     });
                            // }

                            tooltip[targetName].position({
                                x: absPos.x,
                                y: absPos.y - pointRadius,
                            });

                            tooltip[targetName].show();
                        })

                        circle.on('mouseout', function () {
                            // Hide border
                            circle.strokeWidth(0);
                            // Hide tooltip
                            tooltip[targetName].hide();
                        });

                        stage[targetName].on('mouseout', ()=>{tooltip[targetName].hide();});

                        // Delete circle with right click
                        circle.on('contextmenu', (e) => {
                            e.evt.preventDefault();
                            circle.destroy();
                        });
                    };

                    // Save coordinate
                    pointData[table.rows[pointIndex[targetName]].id]={x:pos.x,y:pos.y};

                    // Update pointIndex
                    if (!pointData[table.rows[pointIndex[targetName]+1].id]){
                        pointIndex[targetName]++;
                    }else{
                        pointIndex[targetName] = 0;
                    }

                    // Refresh List Table
                    refreshTable(table);

                    if (pointIndex == table.rows.length){
                        pointIndex = 0;
                    }
                }
            }
        })

        // Reset dragging checker
        KonvaImage[targetName].on('mousedown', function (e) {
            moved = 0;
        });

        // Zoom by wheel
        groupImage[targetName].on('wheel', (e) => {
            // stop default scrolling
            e.evt.preventDefault();

            var oldScale = groupImage[targetName].scaleX();
            var pointer = stage[targetName].getPointerPosition();

            var mousePointTo = {
                x: (pointer.x - groupImage[targetName].x()) / oldScale,
                y: (pointer.y - groupImage[targetName].y()) / oldScale,
            };

            // how to scale? Zoom in? Or zoom out?
            let direction = e.evt.deltaY < 0 ? 1 : -1;

            // when we zoom on trackpad, e.evt.ctrlKey is true
            // in that case lets revert direction
            if (e.evt.ctrlKey) {
                direction = -direction;
            }

            var newScale = direction > 0 ? oldScale * scaleBy : oldScale / scaleBy;

            if (newScale < scaleMin) {
                newScale = scaleMin;
            }
            groupImage[targetName].scale({ x: newScale, y: newScale });


            var newPos = {
                x: pointer.x - mousePointTo.x * newScale,
                y: pointer.y - mousePointTo.y * newScale,
            };
            groupImage[targetName].position(newPos);

            // Keep circle size while zooming
            groupPoint[targetName].children.forEach((child)=>{
                child.scale({x: 1/newScale, y: 1/newScale})
            })
        });

        stage[targetName].on('contextmenu', function (evt) {
            console.log('stage contextmenu')
            // prevent default behavior
            evt.evt.preventDefault();
            if (evt.target === stage[targetName]) {
                // if we are on empty place of the stage we will do nothing
                return;
            }
        });


        tooltip[targetName] = new Konva.Label({
            opacity: 0.75,
            visible: false,
            listening: false,
        });

        tag[targetName] = new Konva.Tag({
            fill: 'black',
            pointerDirection: 'down',
            pointerWidth: 10,
            pointerHeight: 10,
            lineJoin: 'round',
            shadowColor: 'black',
            shadowBlur: 10,
            shadowOffsetX: 10,
            shadowOffsetY: 10,
            shadowOpacity: 0.2,
        });
        tooltip[targetName].add(tag[targetName]);

        tooltip[targetName].add(
            new Konva.Text({
                text: '',
                fontFamily: 'Calibri',
                fontSize: 18,
                padding: 5,
                fill: 'white',
            })
        );

        tooltipLayer[targetName] = new Konva.Layer();
        tooltipLayer[targetName].add(tooltip[targetName]);
        stage[targetName].add(tooltipLayer[targetName]);

    }

    // Refresh konva image frame size while changing navTab
    $('a[data-toggle="pill"]').on('shown.bs.tab',(e)=>{
        if (e.target.role == 'tab') {
            resizeKonva(e.target.id.replace(/-tab/,""))
        }
    })

    // Resize konva image frame while window resize
    window.onresize = function() {
        let activeTab = $('#navTab_mesure >> .nav-link.active')[0];
        if (activeTab.role == 'tab'){
            resizeKonva(activeTab.id.replace(/-tab/,""));
        }
    }
</script>

</html>