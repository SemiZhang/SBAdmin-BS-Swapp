<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Smart WheelChair Application">
    <meta name="author" content="">

    <title>SWApp - Mesure</title>

    <!-- Custom fonts for this template-->
    <link rel="stylesheet" type="text/css" href="vendor/fontawesome-free/css/all.min.css">
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i">

    <!-- Custom styles for this template-->
    <link rel="stylesheet" href="css/sb-admin-2.min.css">
    <link rel="stylesheet" href="css/mesure.css">

    <!-- Jasny-Bootstrap-->
    <link rel="stylesheet" href="vendor/jasny/css/jasny-bootstrap.min.css">

    <!-- Holder.js-->
    <script src="vendor/holderjs/holder.min.js"></script>

</head>

<body id="page-top">

<div id="menu">
    <div>
        <button id="pulse-button">Pulse</button
        ><button id="delete-button">Delete</button>
    </div>
</div>

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Sidebar -->
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

            <!-- Sidebar - Brand -->
            <a class="sidebar-brand d-flex align-items-center justify-content-center my-2" href="index.html">
                <div class="sidebar-brand-icon rotate-n-15">
                    <i class="fas fa-laugh-wink"></i>
                </div>
                <div class="sidebar-brand-text mx-3">SWApp <sup>2</sup></div>
            </a>

            <!-- Divider -->
            <hr class="sidebar-divider my-1">

            <!-- Nav Item - Dashboard -->
            <li class="nav-item">
                <a class="nav-link" href="index.html">
                    <i class="fas fa-fw fa-wheelchair"></i>
                    <span>Réglage du Fauteuil</span></a>
            </li>

            <!-- Nav Item - Mesure -->
            <li class="nav-item active">
                <a class="nav-link" href="mesure.html">
                    <i class="fas fa-fw fa-chart-area fa-ruler-combined"></i>
                    <span>Mesure Photo</span></a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Heading -->
            <div class="sidebar-heading">
                Configuration
            </div>

            <!-- Nav Item - Pages Collapse Menu -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseTwo"
                   aria-expanded="true" aria-controls="collapseTwo">
                    <i class="fas fa-fw fa-cog"></i>
                    <span>Applications</span>
                </a>
                <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Custom Components:</h6>
                        <a class="collapse-item" href="buttons.html">Buttons</a>
                        <a class="collapse-item" href="cards.html">Cards</a>
                    </div>
                </div>
            </li>

            <!-- Nav Item - Utilities Collapse Menu -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseUtilities"
                   aria-expanded="true" aria-controls="collapseUtilities">
                    <i class="fas fa-fw fa-wrench"></i>
                    <span>Utilities</span>
                </a>
                <div id="collapseUtilities" class="collapse" aria-labelledby="headingUtilities"
                     data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Custom Utilities:</h6>
                        <a class="collapse-item" href="utilities-color.html">Colors</a>
                        <a class="collapse-item" href="utilities-border.html">Borders</a>
                        <a class="collapse-item" href="utilities-animation.html">Animations</a>
                        <a class="collapse-item" href="utilities-other.html">Other</a>
                    </div>
                </div>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Heading -->
            <div class="sidebar-heading">
                Documents
            </div>

            <!-- Nav Item - Pages Collapse Menu -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapsePages"
                   aria-expanded="true" aria-controls="collapsePages">
                    <i class="fas fa-fw fa-database"></i>
                    <span>Données enregistrés</span>
                </a>
                <div id="collapsePages" class="collapse" aria-labelledby="headingPages" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Login Screens:</h6>
                        <a class="collapse-item" href="login.html">Login</a>
                        <a class="collapse-item" href="register.html">Register</a>
                        <a class="collapse-item" href="forgot-password.html">Forgot Password</a>
                        <div class="collapse-divider"></div>
                        <h6 class="collapse-header">Other Pages:</h6>
                        <a class="collapse-item" href="404.html">404 Page</a>
                        <a class="collapse-item" href="blank.html">Blank Page</a>
                    </div>
                </div>
            </li>

            <!-- Nav Item - Tables -->
            <li class="nav-item">
                <a class="nav-link" href="tables.html">
                    <i class="fas fa-fw fa-book-open"></i>
                    <span>Mode d'emploie</span></a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider d-none d-md-block">

            <!-- Nav Item - Help -->
            <li class="nav-item">
                <a class="nav-link" href="tables.html">
                    <i class="fas fa-fw fa-phone-alt"></i>
                    <span>Aide & Contact</span></a>
            </li>

            <!-- Sidebar Toggler (Sidebar) -->
            <div class="text-center d-none d-md-inline">
                <button class="rounded-circle border-0 my-4" id="sidebarToggle"></button>
            </div>

            <!-- Sidebar Message -->
            <!--<div class="sidebar-card d-none d-lg-flex">
                <img class="sidebar-card-illustration mb-2" src="img/undraw_rocket.svg" alt="...">
                <p class="text-center mb-2"><strong>SB Admin Pro</strong> is packed with premium features, components, and more!</p>
                <a class="btn btn-success btn-sm" href="https://startbootstrap.com/theme/sb-admin-pro">Upgrade to Pro!</a>
            </div>-->

        </ul>
        <!-- End of Sidebar -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- Main Content -->
            <div id="content">

                <!-- Topbar -->
                <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">

                    <!-- Title -->
                    <div class="container-fluid d-sm-flex align-items-center justify-content-between mx-3">
                        <h1 class="h3 mb-0 text-gray-800">Mesure Photo</h1>
                    </div>

                    <!-- Sidebar Toggle (Topbar) -->
                    <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                        <i class="fa fa-bars"></i>
                    </button>

                </nav>
                <!-- End of Topbar -->

                <!-- Begin Page Content -->
                <div class="container-fluid">

                    <!-- Page Heading -->
                    <!--<h1 class="h3 mb-2 text-gray-800">Mesure Photo</h1>-->
                    <p class="mb-4">Mesurer les paramètres du fauteuil par deux photos, pour plus de détail, veuillez consulter notre <a
                            target="_blank" href="https://www.chartjs.org/docs/latest/">Mode d'emploi</a>.</p>



                    <!-- Content Row -->
                    <div class="row">

                        <div class="col-xl-7 col-lg-6">
                            <!-- Photos -->
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Téléchargement</h6>
                                </div>
                                <div class="card-body">

                                    <div class="fileinput fileinput-new" data-provides="fileinput">
                                        <div class="fileinput-new img-thumbnail" style="width: 300px; height: 200px;">
                                            <img data-src="holder.js/100px100p?text=Face"  alt="...">
                                        </div>
                                        <div class="fileinput-preview fileinput-exists img-thumbnail"
                                             id="image_fauteuil_face" style="max-width: 300x; max-height: 200px;"></div>
                                        <div>
                                            <span class="btn btn-outline-secondary btn-file">
                                                <span class="fileinput-new">Select image</span>
                                                <span class="fileinput-exists">Change</span>
                                                <input type="file" accept="image/*" id="file_fauteuil_face" name="...">
                                            </span>
                                            <a href="#" class="btn btn-outline-secondary fileinput-exists" data-dismiss="fileinput">Remove</a>
                                        </div>
                                    </div>

                                    <div class="fileinput fileinput-new" data-provides="fileinput">
                                        <div class="fileinput-new img-thumbnail" style="width: 300px; height: 200px;">
                                            <img data-src="holder.js/100px100p?text=Profil"  alt="...">
                                        </div>
                                        <div class="fileinput-preview fileinput-exists img-thumbnail"
                                             id="image_fauteuil_profil" style="max-width: 300px; max-height: 200px;"></div>
                                        <div>
                                            <span class="btn btn-outline-secondary btn-file">
                                                <span class="fileinput-new">Select image</span>
                                                <span class="fileinput-exists">Change</span>
                                                <input type="file" accept="image/*" id="file_fauteuil_profil" name="...">
                                            </span>
                                            <a href="#" class="btn btn-outline-secondary fileinput-exists" data-dismiss="fileinput">Remove</a>
                                        </div>
                                    </div>

                                </div>
                            </div>


                            <!--Konva-->
                            <div class="card shadow mb-4" id="card-konva">
                                <div class="card-header py-3">
                                    <div class="row">
                                        <h6 class="m-0 font-weight-bold text-primary col-4">Konva</h6>
                                        <div class="slidecontainer col-4" align="right">
                                            <span align="right">Brightness</span>
                                            <input id="input_brightness"
                                                   value="0" step="0.02" min="-0.8" max="0.8"
                                                   class="form-range" type="range"
                                                   style="width: 80%" />
                                        </div>
                                        <div class="slidecontainer col-4" align="right">
                                            <span align="right">Point Size</span>
                                            <input id="input_pointSize"
                                                   value="5" step="0.5" min="3" max="7"
                                                   class="form-range" type="range"
                                                   style="width: 80%" />
                                        </div>
                                    </div>

                                </div>
                                <div class="card-body" id="konva-container">

                                </div>
                            </div>

                            <!-- Conseils -->
                            <div class="card shadow mb-4">
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Conseils</h6>
                                </div>
                                <div class="card-body">
                                    <p>Prenez les photos à 4 mètres</p>
                                    <p>MODE D'EMPLOI</p>
                                </div>
                            </div>

                        </div>

                        <!-- List -->
                        <div class="col-xl-5 col-lg-6">
                            <div class="card shadow mb-4">
                                <!-- Card Header - Dropdown -->
                                <div class="card-header py-3">
                                    <h6 class="m-0 font-weight-bold text-primary">Liste des points / Liste d'enregistrement</h6>
                                </div>
                                <!-- Card Body -->
                                <div class="card-body">
                                    <table class="table table-striped table-bordered table-hover" id="table_fauteuil_face">
                                        <thead>
                                        <tr><th>Point</th><th>Déscription</th><th>état</th></tr>
                                        </thead>
                                        <tbody data-link="row" class="rowlink">
                                            <tr id="tff_c1b" class="table-active"><td>Calibration1_Bas</a></td><td></td><td class="rowlink-skip"><a>à renseigner</a></td></tr>
                                            <tr id="tff_c1h" class="table-warning"><td>Calibration1_Haut</a></td><td></td><td class="rowlink-skip"><a>à renseigner</a></td></tr>
                                            <tr id="tff_c2b" class="table-danger"><td>Calibration2_Bas</a></td><td></td><td class="rowlink-skip"><a>à renseigner</a></td></tr>
                                            <tr id="tff_c2h" class="table-success"><td>Calibration2_Haut</a></td><td></td><td class="rowlink-skip"><a>à renseigner</a></td></tr>
                                            <tr id="tff_ravtc" class="table-info"><td>Roue Avant_Centre</a></td><td></td><td class="rowlink-skip"><a>à renseigner</a></td></tr>
                                            <tr id="tff_ravte" class="table-primary"><td>Roue Avant_Extrémité</a></td><td></td><td class="rowlink-skip"><a>à renseigner</a></td></tr>
                                            <tr id="tff_fh" class="table-secondary"><td>Fourche_Haut Milieu</a></td><td></td><td class="rowlink-skip"><a>à renseigner</a></td></tr>
                                            <tr id="tff_pp"><td>Potence_Palette</a></td><td></td><td class="rowlink-skip"><a>à renseigner</a></td></tr>
                                            <tr id="tff_savt"><td>Siège_Avant</a></td><td></td><td class="rowlink-skip"><a>à renseigner</a></td></tr>
                                            <tr id="tff_rarre"><td>Roue Arrière_Extrémité</a></td><td></td><td class="rowlink-skip"><a>à renseigner</a></td></tr>
                                            <tr id="tff_mce"><td>Main Courant_Extrémité</a></td><td></td><td class="rowlink-skip"><a>à renseigner</a></td></tr>
                                            <tr id="tff_rarrc"><td>Roue Arrière_Centre</a></td><td></td><td class="rowlink-skip"><a>à renseigner</a></td></tr>
                                            <tr id="tff_sarr"><td>Siège_Arrière</a></td><td></td><td class="rowlink-skip"><a>à renseigner</a></td></tr>
                                            <tr id="tff_dh"><td>Dossier_Haut</a></td><td></td><td class="rowlink-skip"><a>à renseigner</a></td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>



                </div>
                <!-- /.container-fluid -->

            </div>
            <!-- End of Main Content -->

            <!-- Footer -->
            <footer class="sticky-footer bg-white">
                <div class="container my-auto">
                    <div class="copyright text-center my-auto">
                        <span>Copyright &copy; Invalides CERAH</span>
                    </div>
                </div>
            </footer>
            <!-- End of Footer -->

        </div>
        <!-- End of Content Wrapper -->

    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>

    <!-- Logout Modal-->
    <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                    <a class="btn btn-primary" href="login.html">Logout</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>
    <script src="vendor/jasny/js/jasny-bootstrap.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin-2.min.js"></script>

    <!-- Page level plugins -->
<!--    <script src="vendor/chart.js/Chart.min.js"></script>-->
<!--    <script src='https://unpkg.com/panzoom@9.4.0/dist/panzoom.min.js'></script>-->

    <script src="https://unpkg.com/konva@8.3.5/konva.min.js"></script>


    <!-- Page level custom scripts -->
<!--    <script src="js/demo/chart-area-demo.js"></script>-->
<!--    <script src="js/demo/chart-pie-demo.js"></script>-->
<!--    <script src="js/demo/chart-bar-demo.js"></script>-->


</body>

<script>
    // Status of selected point in list table
    pointIndex = 0;
    // Data of all points
    pointData={};



    // document.querySelector("#table_fauteuil_face tbody").addEventListener('click', function(e){
    //     console.log(this)
    // }))

    // Event listener for list table
    document.getElementById('table_fauteuil_face').addEventListener('mouseup',function(e){
        console.log(e.path)
        // console.log(e.path[2].rowIndex)
        pointIndex=e.path[1].rowIndex; // path[1] only work for 'mouseup' event, path[2] for 'mousedown'
        refreshTable(this)
    })

    // List of point should be refreshed after every change
    // Apply color to 'unsaved', 'active', 'saved' rows
    // Update point coordinate data
    function refreshTable(targetTable) {
        // Reinitialize the list table
        Array.from(targetTable.rows).forEach(e=>e.setAttribute('class',''));
        // 'Saved' point
        for (let i in pointData) {
            document.getElementById(i).setAttribute('class','table-success'); // Style included in Bootstrap template
            // Show saved data
            document.getElementById(i).children[1].innerHTML='x:'+parseInt(pointData[i].x)+'&emsp;y:'+parseInt(pointData[i].y);
            // Show saved status
            document.getElementById(i).children[2].innerHTML='Enregistré';

        }
        // 'Active' point
        if (pointIndex>0 && pointIndex < targetTable.rows.length){
            targetTable.rows[pointIndex].setAttribute('class','table-info');
        }
        // document.querySelectorAll("#"+targetTable+" tr").forEach(e=>e.setAttribute('class',''))
        // document.querySelectorAll("#"+targetTable+" tr")[pointIndex].setAttribute('class','table-info')
    }


    // Status of mouse click on image (Used in mouseup event listener of all circles)
    moved=0;
    // Circle default parameter
    pointRadius=5;
    // Scale step
    var scaleBy = 1.05;

    // todo: source and target
    function resizeKonva() {
        var getStyle = function(dom, attr){
            return dom.currentStyle ? dom.currentStyle[attr] : getComputedStyle(dom, false)[attr];
        }
        let div = document.getElementById('konva-container');
        var clientWidth = div.clientWidth;
        var paddingLeft = Number(getStyle(div,"paddingLeft").replace(/\s+|px/gi,""));
        var paddingRight = Number(getStyle(div,"paddingRight").replace(/\s+|px/gi,""));
        var width = clientWidth - paddingLeft - paddingRight;
        var height = width * 3 / 4;

        stage.width(width);
        stage.height(height);
    }

    // Resize image frame while window resize
    window.onresize = function() {
        resizeKonva();
    }

    var stage = new Konva.Stage({
        container: 'konva-container',
    });

    var layer = new Konva.Layer();
    stage.add(layer);

    // Konva.Image.fromURL('/test/face.jpg', function(image){
    //     // image is Konva.Image instance
    //     layer.add(image);
    //     // layer.draw();
    // });

    var image = new Image();
    image.src='/test/face.jpg';
    var KonvaImage = new Konva.Image({
        image: image,
        draggable: false,
        id: 'ki',
    });
    image.onload = function(e) {
        console.log(e);
        let naturalWidth = e.path[0].naturalWidth;
        let naturalHeight = e.path[0].naturalHeight;
        KonvaImage.width(naturalWidth);
        KonvaImage.height(naturalHeight);
        if (naturalWidth > naturalHeight){
            groupImage.scale({x: stage.width()/naturalWidth, y: stage.width()/naturalWidth});
            stage.height(stage.width() / naturalWidth * naturalHeight);
        }else{
            stage.height(stage.width() / naturalWidth * naturalHeight);
            groupImage.scale({x: stage.height()/naturalHeight, y: stage.height()/naturalHeight});
        }
        scaleMin = 0.9 * stage.width()/naturalWidth;

        KonvaImage.cache();
        KonvaImage.filters([Konva.Filters.Brighten]);
    }


    var groupImage = new Konva.Group({
        draggable: true,
    })
    groupImage.add(KonvaImage);

    var groupPoint = new Konva.Group();
    groupImage.add(groupPoint);

    layer.add(groupImage)

    document.getElementById('file_fauteuil_face').addEventListener("input", function(e){
        image.src = URL.createObjectURL(e.target.files[0]);

    })


    const aspectRatio = stage.width() / stage.height();
    const imageRatio = KonvaImage.width() / KonvaImage.height();
    if (aspectRatio <= imageRatio) {
        newWidth = stage.width();
        newHeight = stage.width() / imageRatio;
    } else {
        newWidth = stage.height() * imageRatio;
        newHeight = stage.height();
    }
    KonvaImage.size({
        width: newWidth,
        height: newHeight
    })


    document.getElementById('input_brightness').addEventListener('input', function(){
        // groupImage.children[0].style.filter="brightness(1.5)"
        // console.log(stage.find('#ki')[0].attrs.image.style.filter)
        let value = this.value;
        console.log(parseFloat(value));
        KonvaImage.brightness(parseFloat(this.value));
    })

    document.getElementById('input_pointSize').addEventListener('input', function(){
        pointRadius=this.value;
        groupPoint.children.forEach((e)=>{
            e.radius(this.value);
        })
    })

    resizeKonva();


    // var group = new Konva.Group();
    // layer.add(group);

    var text = new Konva.Text({
        text: 'Click on the canvas to draw a circle',
        fontSize: 20,
        draggable: false,
        y:45,
    });
    layer.add(text);

    var text2 = new Konva.Text({
        text: 'Pointer Position',
        fontSize: 20,
        y:0,
    })
    layer.add(text2);

    var text3 = new Konva.Text({
        text: 'groupImage Position',
        fontSize: 20,
        y:20,
    })
    layer.add(text3);

    stage.on('mouseover mousemove dragmove', ()=>{
        mousePos = stage.getRelativePointerPosition();
        text2.text('Pointer Position:'+mousePos.x+','+mousePos.y)
        text3.text('groupImage Position:'+groupImage.x()+','+groupImage.y())
    })

    stage.on('mouseout', ()=>{
        text2.text('Pointer Position:-1,-1')
    })


    KonvaImage.on('mouseup', function(e){
        // Only active on left click and no dragging movement
        if (e.evt.button==0 && moved==0){
            // Get event List Table
            // todo: variable target table
            let table = document.getElementById('table_fauteuil_face')

            if (pointIndex == 0) {
                window.alert("Choisir d'abord un point parmi la liste")
            }else if (pointIndex < table.rows.length) {
                // Get cursor position
                var pos = KonvaImage.getRelativePointerPosition();
                // Get target point's ID
                let pointID = table.rows[pointIndex].id;

                // Check if circle exist
                let existingCircle = stage.find('#'+pointID)[0];

                if (existingCircle) {
                    // Moving existing circle to new position
                    tween = new Konva.Tween({
                        node: existingCircle,
                        duration: 0.3,
                        x: pos.x,
                        y: pos.y,
                        easing: Konva.Easings.EaseInOut,
                    }).play();
                }else{
                    // Creat circle
                    var circle = new Konva.Circle({
                        x: pos.x,
                        y: pos.y,
                        fill: 'red',
                        stroke: 'blue',
                        strokeWidth: 0,
                        radius: pointRadius,
                        opacity: 0.5,
                        draggable: true,
                        scale: {x:1/groupImage.scaleX(),y:1/groupImage.scaleY()},
                        id: pointID,
                    });
                    // Add circle
                    groupPoint.add(circle);
                    // Add drag listener to circle
                    circle.on('dragmove', (e) => {
                        const absPos = circle.getAbsolutePosition();
                        const relPos = groupImage.getRelativePointerPosition();
                        const image = groupImage.children[0];

                        // Limit point in image border
                        let newAbsPos = { ...absPos };
                        let newRelPos = { ...relPos };
                        if (relPos.x < 0) {
                            newAbsPos.x = groupImage.x();
                            newRelPos.x = 0;
                        }
                        if (relPos.y < 0) {
                            newAbsPos.y = groupImage.y();
                            newRelPos.y = 0;
                        }
                        if (relPos.x > image.width()) {
                            newAbsPos.x = image.width()*groupImage.scaleX() + groupImage.x();
                            newRelPos.x = image.width();
                        }
                        if (relPos.y > image.height()) {
                            newAbsPos.y = image.height()*groupImage.scaleY() + groupImage.y();
                            newRelPos.y = image.height();
                        }
                        circle.setAbsolutePosition(newAbsPos);

                        // Save new position to Data
                        pointData[circle.id()] = newRelPos;

                        // Test function : Show coordinate on image frame
                        text.text('absPos:\t'+newAbsPos.x+','+newAbsPos.y+'\nrelPos:\t'+relPos.x+','+relPos.y)

                        refreshTable(document.getElementById('table_fauteuil_face'))

                    });

                    // Show a stroke on hover
                    circle.on('mouseover mousemove dragmove', () => {
                        // Show border
                        circle.strokeWidth(2);

                        // Update tooltip
                        const absPos = circle.getAbsolutePosition();
                        // var mousePos = node.getStage().getPointerPosition();
                        tooltip
                            .getText()
                            .text(document.getElementById(circle.id()).children[0].innerHTML);

                        // Tried to prevent tooltip from getting out of frame
                        // Limited by Konva, tag position related to pointerDirection only on creation of element

                        // if (absPos.y < tooltip.height()) {
                        //     tag.pointerDirection('up')
                        //     tooltip.position({
                        //         x: absPos.x,
                        //         y: absPos.y + tooltip.height() + tag.pointerHeight() + pointRadius,
                        //     });
                        // }else{
                        //     tag.pointerDirection('down')
                        //     tooltip.position({
                        //         x: absPos.x,
                        //         y: absPos.y - pointRadius,
                        //     });
                        // }
                        //
                        // if (absPos.x < tooltip.width()/2) {
                        //     tag.pointerDirection('left')
                        //     tooltip.position({
                        //         x: absPos.x + pointRadius,
                        //         y: absPos.y,
                        //     });
                        // }else if (absPos.x > stage.width() - tooltip.width()/2) {
                        //     tag.pointerDirection('right')
                        //     tooltip.position({
                        //         x: absPos.x - pointRadius,
                        //         y: absPos.y,
                        //     });
                        // }

                        tooltip.position({
                            x: absPos.x,
                            y: absPos.y - pointRadius,
                        });

                        tooltip.show();
                    })

                    circle.on('mouseout', function () {
                        // Hide border
                        circle.strokeWidth(0);
                        // Hide tooltip
                        tooltip.hide();
                    });

                    stage.on('mouseout', ()=>{tooltip.hide();});

                    // Delete circle with right click
                    circle.on('contextmenu', (e) => {
                        e.evt.preventDefault();
                        circle.destroy();
                    });
                };

                // Save coordinate
                pointData[table.rows[pointIndex].id]={x:pos.x,y:pos.y};

                // Update pointIndex
                if (!pointData[table.rows[pointIndex+1].id]){
                    pointIndex++;
                }else{
                    pointIndex = 0;
                }

                // Refresh List Table
                refreshTable(table);

                if (pointIndex == table.rows.length){
                    pointIndex = 0;
                }
            }
        }
    })

    // Reset dragging checker
    KonvaImage.on('mousedown', function (e) {
        moved = 0;
    });

    // Zoom by wheel
    groupImage.on('wheel', (e) => {
        // stop default scrolling
        e.evt.preventDefault();

        var oldScale = groupImage.scaleX();
        var pointer = stage.getPointerPosition();

        var mousePointTo = {
            x: (pointer.x - groupImage.x()) / oldScale,
            y: (pointer.y - groupImage.y()) / oldScale,
        };

        // how to scale? Zoom in? Or zoom out?
        let direction = e.evt.deltaY < 0 ? 1 : -1;

        // when we zoom on trackpad, e.evt.ctrlKey is true
        // in that case lets revert direction
        if (e.evt.ctrlKey) {
            direction = -direction;
        }

        var newScale = direction > 0 ? oldScale * scaleBy : oldScale / scaleBy;

        if (newScale < scaleMin) {
            newScale = scaleMin;
        }
        groupImage.scale({ x: newScale, y: newScale });

        var newPos = {
            x: pointer.x - mousePointTo.x * newScale,
            y: pointer.y - mousePointTo.y * newScale,
        };
        groupImage.position(newPos);

        // Keep circle size while zooming
        groupPoint.children.forEach((child)=>{
            child.scale({x: 1/newScale, y: 1/newScale})
        })
    });

    stage.on('contextmenu', function (evt) {
        console.log('stage contextmenu')
        // prevent default behavior
        evt.evt.preventDefault();
        if (evt.target === stage) {
            // if we are on empty place of the stage we will do nothing
            return;
        }
    });


    var tooltipLayer = new Konva.Layer();

    var tooltip = new Konva.Label({
        opacity: 0.75,
        visible: false,
        listening: false,
    });

    var tag = new Konva.Tag({
        fill: 'black',
        pointerDirection: 'down',
        pointerWidth: 10,
        pointerHeight: 10,
        lineJoin: 'round',
        shadowColor: 'black',
        shadowBlur: 10,
        shadowOffsetX: 10,
        shadowOffsetY: 10,
        shadowOpacity: 0.2,
    });
    tooltip.add(tag);

    tooltip.add(
        new Konva.Text({
            text: '',
            fontFamily: 'Calibri',
            fontSize: 18,
            padding: 5,
            fill: 'white',
        })
    );

    tooltipLayer.add(tooltip);
    stage.add(tooltipLayer);

    stage.on('mouseover mousemove dragmove', function (evt) {
        moved = 1;
    });

    var sceneWidth = 1920;
    var sceneHeight = 1080;

    // function fitStageIntoParentContainer() {
    //     var container = document.getElementById('container-parent');
    //
    //     // now we need to fit stage into parent container
    //     var containerWidth = container.offsetWidth;
    //
    //     // but we also make the full scene visible
    //     // so we need to scale all objects on canvas
    //     var scale = containerWidth / sceneWidth;
    //
    //     stage.width(sceneWidth * scale);
    //     stage.height(sceneHeight * scale);
    //     stage.scale({ x: scale, y: scale });
    // }
    // fitStageIntoParentContainer();
    // // adapt the stage on any window resize
    // window.addEventListener('resize', fitStageIntoParentContainer);


    function getCorner(pivotX, pivotY, diffX, diffY, angle) {
        const distance = Math.sqrt(diffX * diffX + diffY * diffY);

        /// find angle from pivot to corner
        angle += Math.atan2(diffY, diffX);

        /// get new x and y and round it off to integer
        const x = pivotX + distance * Math.cos(angle);
        const y = pivotY + distance * Math.sin(angle);

        return { x: x, y: y };
    }
    function getClientRect(rotatedBox) {
        const { x, y, width, height } = rotatedBox;
        const rad = rotatedBox.rotation;

        const p1 = getCorner(x, y, 0, 0, rad);
        const p2 = getCorner(x, y, width, 0, rad);
        const p3 = getCorner(x, y, width, height, rad);
        const p4 = getCorner(x, y, 0, height, rad);

        const minX = Math.min(p1.x, p2.x, p3.x, p4.x);
        const minY = Math.min(p1.y, p2.y, p3.y, p4.y);
        const maxX = Math.max(p1.x, p2.x, p3.x, p4.x);
        const maxY = Math.max(p1.y, p2.y, p3.y, p4.y);

        return {
            x: minX,
            y: minY,
            width: maxX - minX,
            height: maxY - minY,
        };
    }
    function getTotalBox(boxes) {
        let minX = Infinity;
        let minY = Infinity;
        let maxX = -Infinity;
        let maxY = -Infinity;

        boxes.forEach((box) => {
            minX = Math.min(minX, box.x);
            minY = Math.min(minY, box.y);
            maxX = Math.max(maxX, box.x + box.width);
            maxY = Math.max(maxY, box.y + box.height);
        });
        return {
            x: minX,
            y: minY,
            width: maxX - minX,
            height: maxY - minY,
        };
    }
</script>

</html>